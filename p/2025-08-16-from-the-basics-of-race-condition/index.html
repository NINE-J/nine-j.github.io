<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="자바 실전 대응 전략"><title>Race condition 뿌리부터 잡기</title><link rel=canonical href=https://b9f1.com/p/2025-08-16-from-the-basics-of-race-condition/><link rel=stylesheet href=/scss/style.min.a4c8bc08e651638162859c41dc052774277a818ec59b538125ecc01c7e8eebf0.css><meta property='og:title' content="Race condition 뿌리부터 잡기"><meta property='og:description' content="자바 실전 대응 전략"><meta property='og:url' content='https://b9f1.com/p/2025-08-16-from-the-basics-of-race-condition/'><meta property='og:site_name' content='B9F1'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='devlog'><meta property='article:tag' content='race-condition'><meta property='article:tag' content='멀티스레딩'><meta property='article:tag' content='동시성처리'><meta property='article:tag' content='동시성제어'><meta property='article:tag' content='Concurrency'><meta property='article:tag' content='synchronized'><meta property='article:tag' content='ReentrantLock'><meta property='article:tag' content='volatile'><meta property='article:tag' content='AtomicInteger'><meta property='article:tag' content='CAS'><meta property='article:tag' content='LongAdder'><meta property='article:tag' content='ConcurrentHashMap'><meta property='article:tag' content='jcstrees'><meta property='article:published_time' content='2025-08-16T00:00:00+09:00'><meta property='article:modified_time' content='2025-08-16T00:00:00+09:00'><meta property='og:image' content='https://b9f1.com/p/2025-08-16-from-the-basics-of-race-condition/cover.png'><meta name=twitter:title content="Race condition 뿌리부터 잡기"><meta name=twitter:description content="자바 실전 대응 전략"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://b9f1.com/p/2025-08-16-from-the-basics-of-race-condition/cover.png'><link rel="shortcut icon" href=/favicon.svg><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7023370172872685" crossorigin=anonymous></script><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=b9f1 data-description="Support me on Buy me a coffee!" data-message="👋 Glad to meet you.Buy me a coffee? 😊" data-color=#5F7FFF data-position=Right data-x_margin=18 data-y_margin=18></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_2f326f6839e2d588.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🤌</span></figure><div class=site-meta><h1 class=site-name><a href=/>B9F1</a></h1><h2 class=site-description>Nine's Devlog</h2></div></header><ol class=menu-social><li><a href=https://github.com/NINE-J target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://stackoverflow.com/users/17334807/nine target=_blank title=StackOverflow rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-stackoverflow"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 17v1a2 2 0 002 2h12a2 2 0 002-2v-1"/><path d="M8 16h8"/><path d="M8.322 12.582l7.956.836"/><path d="M8.787 9.168l7.826 1.664"/><path d="M10.096 5.764l7.608 2.472"/></svg></a></li><li><a href=mailto:rnwo47@gmail.com target=_blank title=ZMail rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-mail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/><path d="M3 7l9 6 9-6"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/toys/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Toys</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#개요>📌개요</a></li><li><a href=#내용>📌내용</a><ol><li><a href=#경쟁-상태란-무엇인가>경쟁 상태란 무엇인가?</a></li><li><a href=#위험-신호와-재현-패턴>위험 신호와 재현 패턴</a></li><li><a href=#최소-예제로-보는-버그>최소 예제로 보는 버그</a><ol><li><a href=#바이트코드-관점필드-증가>바이트코드 관점(필드 증가)</a></li><li><a href=#interleaving-예-두-스레드>Interleaving 예 (두 스레드)</a></li></ol></li><li><a href=#가시성까지-얽히면-더-위험>가시성까지 얽히면 더 위험</a></li><li><a href=#왜-volatile로-해결되지-않나>왜 <code>volatile</code>로 해결되지 않나?</a></li><li><a href=#해결-전략-락보다-설계가-먼저>해결 전략: 락보다 설계가 먼저</a><ol><li><a href=#상태-자체를-줄여라>상태 자체를 줄여라</a></li><li><a href=#스레드-컨파인먼트>스레드 컨파인먼트</a></li><li><a href=#원자-연산--동시-컬렉션-juc>원자 연산 & 동시 컬렉션 (J.U.C)</a></li><li><a href=#동기화-synchronization>동기화 (Synchronization)</a></li><li><a href=#가시성-보장--안전한-게시>가시성 보장 & 안전한 게시</a></li><li><a href=#단일-실행--멱등idempotency>단일 실행 & 멱등(Idempotency)</a></li></ol></li><li><a href=#실전-시나리오별-추천-레시피>실전 시나리오별 추천 레시피</a></li><li><a href=#성능-vs-정확성-트레이드오프>성능 vs 정확성 트레이드오프</a></li><li><a href=#테스트검증-전략>테스트·검증 전략</a></li></ol></li><li><a href=#결론>🎯결론</a></li><li><a href=#endnote>⚙️EndNote</a><ol><li><a href=#사전-지식>사전 지식</a></li><li><a href=#더-알아보기>더 알아보기</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/2025-08-16-from-the-basics-of-race-condition/><img src=/p/2025-08-16-from-the-basics-of-race-condition/cover_hu_9c589cc9551386cb.png srcset="/p/2025-08-16-from-the-basics-of-race-condition/cover_hu_9c589cc9551386cb.png 800w, /p/2025-08-16-from-the-basics-of-race-condition/cover_hu_2a539b6a5bfaf42f.png 1600w" width=800 height=450 loading=lazy alt="Featured image of post Race condition 뿌리부터 잡기"></a></div><div class=article-details><header class=article-category><a href=/categories/backend/>Backend
</a><a href=/categories/concurrency/>Concurrency</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/2025-08-16-from-the-basics-of-race-condition/>Race condition 뿌리부터 잡기</a></h2><h3 class=article-subtitle>자바 실전 대응 전략</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2025년 08월 16일</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>5 minute read</time></div></footer></div></header><section class=article-content><h2 id=개요>📌개요</h2><p>트래픽이 두 배가 되는 순간, 가장 먼저 터지는 건 <strong>성능</strong>이 아니라 <strong>정합성</strong>이다.</p><p>멀티스레드 환경의 대표적 복병 <strong>경쟁 상태(Race Condition)</strong> 는 재현도 어렵고 한 번 새면 데이터 신뢰도가 무너진다.</p><p>운영 환경에서 빈번하게 마주치는 <strong>경쟁 상태의 원인</strong>, <strong>재현 패턴</strong>, <strong>해결 전략의 우선순위</strong>를 정리한다.</p><h2 id=내용>📌내용</h2><h3 id=경쟁-상태란-무엇인가>경쟁 상태란 무엇인가?</h3><link rel=stylesheet href=/css/vendors/admonitions.5c21d3611305826ca76e50bf22bdda6ed74f2f81d26216e9166f9ae104f2e27a.css integrity="sha256-XCHTYRMFgmynblC/Ir3abtdPL4HSYhbpFm+a4QTy4no=" crossorigin=anonymous><div class="admonition info"><div class=admonition-header><svg viewBox="0 0 512 512"><path d="M256 512A256 256 0 10256 0a256 256 0 100 512zM216 336h24v-64h-24c-13.3.0-24-10.7-24-24s10.7-24 24-24h48c13.3.0 24 10.7 24 24v88h8c13.3.0 24 10.7 24 24s-10.7 24-24 24h-80c-13.3.0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 110 64 32 32 0 110-64z"/></svg>
<span>정의<br></span></div><div class=admonition-content><p>여러 스레드가 <strong>공유 상태(shared state)</strong> 를 동시에 읽고/쓰기 하며 실행 타이밍에 따라 결과가 달라지는 상황.<br>핵심 원인 축: <strong>AVR</strong> - Atomicity(원자성), Visibility(가시성), Reordering(재배치).</p></div></div><ul><li><strong>Atomicity</strong>: <code>x = x + 1</code> 같은 RMW(Read–Modify–Write) 연산이 중간에 끼어들기로 깨지면서 lost update 발생</li><li><strong>Visibility</strong>: 한 스레드의 쓰기가 다른 스레드에 늦게 보여 stale value(오래된 값) 관측, 잘못된 분기<ul><li>stale value: 다른 스레드가 최신 값을 썼음에도 불구하고, 캐시/레지스터 등 중간 계층에 남아있던 <strong>이전 값</strong></li><li>이 때문에 <strong>중복 및 누락</strong>뿐 아니라 <code>if (value==0)</code> 같은 <strong>조건 분기 오류</strong>가 발생</li></ul></li><li><strong>Reordering</strong>: CPU out-of-order 실행이나 JIT 최적화로 happens-before 순서가 무너짐</li></ul><h3 id=위험-신호와-재현-패턴>위험 신호와 재현 패턴</h3><ul><li><strong>증상</strong>: 카운터 불일치, 중복/누락, “가끔” 실패하는 테스트, 운영 환경에서만 나타나는 버그(Heisenbug)</li><li><strong>패턴</strong>:<ul><li><code>if(없으면 저장)</code> 후 put (TOCTOU)</li><li>캐시 초기화 동시 접근</li><li>통계 카운터 증가</li><li>잘못된 Lazy init</li></ul></li></ul><div class="admonition info"><div class=admonition-header><svg viewBox="0 0 512 512"><path d="M256 512A256 256 0 10256 0a256 256 0 100 512zM216 336h24v-64h-24c-13.3.0-24-10.7-24-24s10.7-24 24-24h48c13.3.0 24 10.7 24 24v88h8c13.3.0 24 10.7 24 24s-10.7 24-24 24h-80c-13.3.0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 110 64 32 32 0 110-64z"/></svg>
<span>Heisenbug</span></div><div class=admonition-content><p>하이젠버그는 프로그래밍에서 테스트를 수행할 때 발생되는 버그의 형태 중의 하나로서 문제를 발견하고 수정하기 위한 디버깅을 수행하려고 하면 문제점이 사라지는 형태의 버그를 말한다.</p></div></div><div class="admonition info"><div class=admonition-header><svg viewBox="0 0 512 512"><path d="M256 512A256 256 0 10256 0a256 256 0 100 512zM216 336h24v-64h-24c-13.3.0-24-10.7-24-24s10.7-24 24-24h48c13.3.0 24 10.7 24 24v88h8c13.3.0 24 10.7 24 24s-10.7 24-24 24h-80c-13.3.0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 110 64 32 32 0 110-64z"/></svg>
<span>TOCTOU (Time Of Check to Time Of Use)<br></span></div><div class=admonition-content><p>검사 시점과 사용 시점 사이의 틈새에서 다른 스레드가 상태를 바꿔 <strong>예상치 못한 버그 및 보안 취약점</strong>을 유발하는 <strong>클래식 경쟁 조건 유형</strong>.</p></div></div><h3 id=최소-예제로-보는-버그>최소 예제로 보는 버그</h3><div class="admonition warning"><div class=admonition-header><svg viewBox="0 0 512 512"><path d="M256 32c14.2.0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7.2 40.1S486.3 480 472 480H40c-14.3.0-27.6-7.7-34.7-20.1s-7-27.8.2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3.0-24 10.7-24 24v112c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 10-64 0 32 32 0 1064 0z"/></svg>
<span>원자적이지 않은 연산<br></span></div><div class=admonition-content><p><code>value++</code> 는 단일 연산처럼 보이지만, JVM 바이트코드 레벨에서는 <code>getfield</code> → <code>iconst_1</code> → <code>iadd</code> → <code>putfield</code> 로 분해된다.
중간에 다른 스레드가 끼어들어 lost update 발생. <code>volatile</code>은 가시성만 보장해도 원자성은 보장 못 한다.</p></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>BrokenCounter</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>inc</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>value</span><span class=o>++</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>  </span><span class=c1>// 경쟁 상태</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=nf>get</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=바이트코드-관점필드-증가>바이트코드 관점(필드 증가)</h4><ul><li><code>getfield value</code> → <code>iconst_1</code> → <code>iadd</code> → <code>putfield value</code></li><li>단일 연산이 아니라 여러 명령어로 분해됨 → 원자성 깨짐</li></ul><h4 id=interleaving-예-두-스레드>Interleaving 예 (두 스레드)</h4><ul><li>두 번 증가 의도 → 최종 값 1 (한 번만 반영)</li><li>DB의 <strong>Lost Update anomaly</strong>와 동일한 문제</li></ul><h3 id=가시성까지-얽히면-더-위험>가시성까지 얽히면 더 위험</h3><ul><li>A 스레드가 <code>1</code> 저장해도, B 스레드는 캐시 coherence 지연으로 여전히 <code>0</code>(stale value) 관측</li><li>결과:<ol><li>카운터 중복·누락</li><li>조건 분기 오류 (예: <code>if (get()==0) init()</code>이 중복 실행)</li></ol></li></ul><h3 id=왜-volatile로-해결되지-않나>왜 <code>volatile</code>로 해결되지 않나?</h3><ul><li><code>volatile</code>은 가시성(Visibility)과 재배치(Reordering) 방지 일부를 보장한다.</li><li>하지만 <code>value++</code> 같은 RMW 원자성은 보장 못 함</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>volatile</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>void</span><span class=w> </span><span class=nf>inc</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>value</span><span class=o>++</span><span class=p>;</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=c1>// 여전히 lost update 가능</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=해결-전략-락보다-설계가-먼저>해결 전략: 락보다 설계가 먼저</h3><h4 id=상태-자체를-줄여라>상태 자체를 줄여라</h4><ul><li>불변 객체(Immutable), Copy-on-Write, 메시지 패싱/Actor 모델, 이벤트 루프</li></ul><h4 id=스레드-컨파인먼트>스레드 컨파인먼트</h4><ul><li><code>ThreadLocal</code>, 키 파티셔닝(같은 키는 동일 워커로)</li></ul><h4 id=원자-연산--동시-컬렉션-juc>원자 연산 & 동시 컬렉션 (J.U.C)</h4><ul><li><code>AtomicInteger.incrementAndGet()</code> (CAS 기반)<ul><li>CAS(Compare-And-Swap)는 <strong>재시도 루프(spin)</strong> 구조로 동작한다. 즉, 경쟁이 심하면 충돌이 잦아지고 성능이 급격히 저하될 수 있다.</li></ul></li><li>고경합 환경엔 <code>LongAdder</code><ul><li>내부적으로 셀(Cell) 배열에 분산 저장하여 스레드 충돌을 줄인다.</li><li>주기적 집계를 통해 최종 값을 계산 → CAS 충돌 병목이 적음.</li></ul></li><li><code>ConcurrentHashMap.computeIfAbsent/merge</code>로 TOCTOU 제거</li></ul><div class="admonition info"><div class=admonition-header><svg viewBox="0 0 512 512"><path d="M256 512A256 256 0 10256 0a256 256 0 100 512zM216 336h24v-64h-24c-13.3.0-24-10.7-24-24s10.7-24 24-24h48c13.3.0 24 10.7 24 24v88h8c13.3.0 24 10.7 24 24s-10.7 24-24 24h-80c-13.3.0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 110 64 32 32 0 110-64z"/></svg>
<span>CAS와 성능<br></span></div><div class=admonition-content><p>CAS는 실패 시 루프를 돌며 재시도하는 <strong>spin 기반 알고리즘</strong>이다.
경쟁이 적을 땐 락보다 빠르지만, 경쟁이 많으면 계속 충돌 → 재시도로 인해 오히려 락보다 느려질 수 있다.
이 때문에 고경합 상황에서는 <code>LongAdder</code> 같은 분산 구조가 더 유리하다.</p></div></div><h4 id=동기화-synchronization>동기화 (Synchronization)</h4><ul><li><code>synchronized</code> (간단, 확실)</li><li><code>ReentrantLock</code> (tryLock, 타임아웃 지원)</li><li><code>ReadWriteLock</code>, <code>StampedLock</code> (낙관적 읽기 성능 개선)<ul><li><code>StampedLock</code>의 <strong>낙관적 읽기</strong>는 실제 읽은 값이 도중에 다른 쓰기에 의해 깨지지 않았는지 <code>validate(stamp)</code> 호출로 반드시 검증해야 안전하다.</li></ul></li></ul><div class="admonition info"><div class=admonition-header><svg viewBox="0 0 512 512"><path d="M256 512A256 256 0 10256 0a256 256 0 100 512zM216 336h24v-64h-24c-13.3.0-24-10.7-24-24s10.7-24 24-24h48c13.3.0 24 10.7 24 24v88h8c13.3.0 24 10.7 24 24s-10.7 24-24 24h-80c-13.3.0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 110 64 32 32 0 110-64z"/></svg>
<span>StampedLock의 validate()<br></span></div><div class=admonition-content><p><code>long stamp = lock.tryOptimisticRead();</code> → 값 읽기 → <code>if (!lock.validate(stamp)) { ...재시도... }</code>
낙관적 읽기는 무조건 성공하는 게 아니라, 읽은 후에 검증(validate)을 반드시 거쳐야 한다. 검증이 실패하면 일반적인 읽기 락을 다시 걸어야 한다.</p></div></div><h4 id=가시성-보장--안전한-게시>가시성 보장 & 안전한 게시</h4><ul><li><code>volatile</code> 플래그, <code>final</code> 필드</li><li>Safe Publication (동기화 통해 객체를 게시)</li></ul><h4 id=단일-실행--멱등idempotency>단일 실행 & 멱등(Idempotency)</h4><ul><li>멱등 설계, fencing token(순서 보장 토큰)</li></ul><h3 id=실전-시나리오별-추천-레시피>실전 시나리오별 추천 레시피</h3><div class=table-wrapper><table><thead><tr><th>시나리오</th><th>증상</th><th>해법</th></tr></thead><tbody><tr><td>동시 카운팅/지표</td><td>증발(Lost update)</td><td><code>LongAdder</code> → 주기적 집계</td></tr><tr><td>Lazy 초기화</td><td>중복 생성</td><td><code>computeIfAbsent</code>, 초기화 전용 락</td></tr><tr><td>캐시 프리로드</td><td>중복 로드</td><td>키 파티셔닝 + 단일 워커</td></tr><tr><td>읽기 99%</td><td>락 경합</td><td>Copy-on-Write, <code>StampedLock</code> 낙관 읽기</td></tr><tr><td>고가 연산 임계구역</td><td>응답 지연</td><td>임계구역 축소, 분해락(키별 락)</td></tr><tr><td>키 충돌 업데이트</td><td>중복·경합</td><td>키별 락/Striped Lock, <code>merge</code></td></tr></tbody></table></div><h3 id=성능-vs-정확성-트레이드오프>성능 vs 정확성 트레이드오프</h3><ol><li><strong>정확성 고정</strong>: <code>synchronized</code>/ConcurrentHashMap으로 정합성 우선 확보</li><li><strong>핫스팟 튜닝</strong>: 임계구역 축소, 자료구조 교체</li><li><strong>마지막에</strong>: 락-프리/낙관적 기법 적용</li></ol><h3 id=테스트검증-전략>테스트·검증 전략</h3><ul><li><strong>jcstress</strong> (OpenJDK 동시성 경계 테스트 프레임워크)</li><li><strong>확률 테스트</strong> (스레드 수·코어 수·JVM 옵션 다양화)</li><li><strong>페일패스트 계측</strong> (불가능 상태 assert)</li><li><strong>장시간 soak test</strong> (운영 유사 환경)</li><li>이런 버그는 <strong>Heisenbug</strong> 특성이 강함 → 반드시 장기간·다양 환경에서 검증 필요</li></ul><h2 id=결론>🎯결론</h2><p><strong>공유 상태를 최소화하라.</strong>
남는 공유 상태는 반드시 <strong>J.U.C(java.util.concurrent)</strong> 와 <strong>명시적 동기화</strong>로 보호하라.
먼저 정합성을 보장하고, 이후 성능을 최적화하는 순서가 바람직하다.</p><h2 id=endnote>⚙️EndNote</h2><h3 id=사전-지식>사전 지식</h3><ul><li>Java Memory Model(JMM), happens-before</li><li>monitor/synchronized, CAS(compare-and-swap)</li><li>J.U.C(java.util.concurrent): 원자 클래스, 동시 컬렉션</li></ul><h3 id=더-알아보기>더 알아보기</h3><ul><li>Java Concurrency in Practice (Brian Goetz)</li><li>Effective Java 동시성 아이템</li><li>OpenJDK <strong>jcstress</strong></li><li>Oracle Concurrency 튜토리얼</li><li>Martin Kleppmann: Idempotency / Exactly-once</li></ul></section><footer class=article-footer><div style=margin-top:2rem;text-align:center><a href=https://www.buymeacoffee.com/b9f1 target=_blank><img src=https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png alt="Buy Me A Coffee" style=height:60px!important;width:217px!important></a></div><section class=article-tags><a href=/tags/devlog/>Devlog</a>
<a href=/tags/race-condition/>Race-Condition</a>
<a href=/tags/%EB%A9%80%ED%8B%B0%EC%8A%A4%EB%A0%88%EB%94%A9/>멀티스레딩</a>
<a href=/tags/%EB%8F%99%EC%8B%9C%EC%84%B1%EC%B2%98%EB%A6%AC/>동시성처리</a>
<a href=/tags/%EB%8F%99%EC%8B%9C%EC%84%B1%EC%A0%9C%EC%96%B4/>동시성제어</a>
<a href=/tags/concurrency/>Concurrency</a>
<a href=/tags/synchronized/>Synchronized</a>
<a href=/tags/reentrantlock/>ReentrantLock</a>
<a href=/tags/volatile/>Volatile</a>
<a href=/tags/atomicinteger/>AtomicInteger</a>
<a href=/tags/cas/>CAS</a>
<a href=/tags/longadder/>LongAdder</a>
<a href=/tags/concurrenthashmap/>ConcurrentHashMap</a>
<a href=/tags/jcstrees/>Jcstrees</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".main-article");renderMathInElement(e,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/2025-10-10-outbox-patterns-for-data-consistency-and-event-reliability-in-msa/><div class=article-image><img src=/p/2025-10-10-outbox-patterns-for-data-consistency-and-event-reliability-in-msa/cover.40b2b1475caf217cd2efd0d6aaa7500c_hu_7ad7d8398d320571.png width=250 height=150 loading=lazy alt="Featured image of post MSA Outbox 패턴" data-hash="md5-QLKxR1yvIXzS79DWqqdQDA=="></div><div class=article-details><h2 class=article-title>MSA Outbox 패턴</h2></div></a></article><article class=has-image><a href=/p/2025-08-30-local-cache-vs-distributed-cache/><div class=article-image><img src=/p/2025-08-30-local-cache-vs-distributed-cache/cover.28488ebcd4d3d59ccb9bf00bf123bd9a_hu_10d5a5bfd68a230e.png width=250 height=150 loading=lazy alt="Featured image of post 로컬 캐시 vs 분산 캐시" data-hash="md5-KEiOvNTT1ZzLm/AL8SO9mg=="></div><div class=article-details><h2 class=article-title>로컬 캐시 vs 분산 캐시</h2></div></a></article><article class=has-image><a href=/p/2025-08-16-addressing-contextual-information-such-as-mdc-and-securitycontext-in-asynchronous-environments/><div class=article-image><img src=/p/2025-08-16-addressing-contextual-information-such-as-mdc-and-securitycontext-in-asynchronous-environments/cover.cf55ad2db446008dfb4c00dce76737d6_hu_d2672a8c79cd12a9.png width=250 height=150 loading=lazy alt="Featured image of post 컨텍스트 안전 전파" data-hash="md5-z1WtLbRGAI37TADc52c31g=="></div><div class=article-details><h2 class=article-title>컨텍스트 안전 전파</h2></div></a></article><article class=has-image><a href=/p/2025-08-05-lets-find-out-the-structure-and-each-component-of-json-web-token-in-detail/><div class=article-image><img src=/p/2025-08-05-lets-find-out-the-structure-and-each-component-of-json-web-token-in-detail/cover.f9b4e9327b66a0628f8e1d6140dde64f_hu_20bd9d613d2a74ad.png width=250 height=150 loading=lazy alt="Featured image of post JWT 구조를 구체적으로 알아보자" data-hash="md5-+bTpMntmoGKPjh1hQN3mTw=="></div><div class=article-details><h2 class=article-title>JWT 구조를 구체적으로 알아보자</h2></div></a></article><article class=has-image><a href=/p/2025-08-04-understanding-the-oauth-2.0-core-structure/><div class=article-image><img src=/p/2025-08-04-understanding-the-oauth-2.0-core-structure/cover.48f64618b60f085c1d7b703e27e2415b_hu_4097a33b7d11d1e.png width=250 height=150 loading=lazy alt="Featured image of post OAuth 2.0 핵심 구조 이해하기" data-hash="md5-SPZGGLYPCFwde3A+J+JBWw=="></div><div class=article-details><h2 class=article-title>OAuth 2.0 핵심 구조 이해하기</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=nine-j/nine-j.github.io data-repo-id=R_kgDOOqUgZw data-category=General data-category-id=DIC_kwDOOqUgZ84CqLyQ data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en data-loading crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"noborder_gray")}})()</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 B9F1</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.31.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>